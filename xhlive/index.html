<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link href="css/qiniuplayer-0.3.9.min.css" rel="stylesheet">
    <link href="css/index.css" rel="stylesheet">
</head>

<body>

<div class="pages">
    <header class="huya-header">
        <a class="logo clickstat" href="#"></a>
        <a class="header-app-btn u-btn-down" >打开App</a>
    </header>

    <div style="position: relative">
        <video id="demo-video" class="video-js vjs-big-play-centered" x5-video-player-fullscreen="true"  x5-playsinline="true" playsinline="true" webkit-playsinline="true">

        </video>
        <div class="video-end">直播已结束</div>
    </div>

    <div class="m-room-tabs">
        <div class="live_title">
            <div class="live_title_content">
                <span class="live_title_left">主播</span>
                <span class="live_title_riht"></span>
            </div>
            <span class="live_title_desc"></span>
        </div>
        <div class="live_rule">比赛规则：<span class="live_rule_desc"></span><span class="right-arrow"></span></div>
    </div>

    <div id="chatroom_msg" class="chatroom_msg"><div class="red_container">

    </div></div>

    <div class="danmu">
        <div class="left"><span>发个弹幕~</span></div>
        <div class="right"><img src="img/icon-danmu.png"></div>
    </div>
</div>

<script src="../public/jquery.min.js"></script>
<script src="js/qiniuplayer-0.3.9.min.js"></script>
<script src="js/NIM_Web_Chatroom_v6.0.0.js"></script>
<script src="../public/config.js"></script>
<script src="../public/service.js"></script>
    <script>

    var config = {
        downloadUrl: 'http://www.tinytiger.cn/',
        url: 'LiveListController/getLiveInfo',
        type: 'post',
        data: { live_id: Request('live_id'),live_save_id: Request('live_save_id') || null},
        token: null,
        randomName: Math.floor(Math.random()*10000),
        options: null,
        chatroom: null,
        chatroomInfo: null,
        player: null
    };

    requsetHttp(config.url, config.type, config.data ,config.token,(res)=>{
        if (res.status != 1){
            countHeight();
            $('.video-end').css('display','flex');
            return false;
        }
        $('.live_title_left').text(res.data.live_info.room_name);
        $('.live_title_desc').text(res.data.live_info.room_intro);
        $('.live_rule_desc').text(res.data.live_info.room_desc);
        config.options = {
            controls: true, //是否显示播放器底部的控制栏。
            url: res.data.live_info.hdl_url ,
            type: 'hls',
            preload: 'auto', //设置视频是否会自动加载。
            autoplay: false, // 如为 true，则视频将会自动播放
            poster: res.data.live_info.room_image,
            width: document.documentElement.clientWidth,
            height: document.documentElement.clientWidth * 0.5625,
            stretching: 'panscan',
        };
        if(res.data.live_info.is_end == 0){//直播
            config.chatroom = Chatroom.getInstance({
                appKey: '2991ded3e2281d5289b9782ef6f5d918',
                chatroomNick: '游客_'+ config.randomName,
                isAnonymous: true,
                chatroomId: res.data.chat_room_info.room_id,
                chatroomAddresses: res.data.chat_room_info.web_chat_room_url,
                onconnect: onChatroomConnect,
                onwillreconnect: onChatroomWillReconnect,
                ondisconnect: onChatroomDisconnect,
                onerror: onChatroomError,
                onmsgs: onChatroomMsgs,
            });
            config.options.url =  res.data.live_info.hdl_url ;
            config.player = new QiniuPlayer('demo-video', config.options);
        }else{//回放
            config.options.url =  res.data.live_info.save_url ;
            config.player = new QiniuPlayer('demo-video', config.options);
        }
        config.player.ready(function () {//此处可自行修改控件以及监听事件
            config.player.on('error', function(res) { });
            config.player.on('useractive', function(res) { });
        });
        countHeight();
    });

    function countHeight() {
        var heiht = $(window).height() - $('.huya-header').height() - $('#demo-video').height() - $('.m-room-tabs').height() - $('.danmu').height() - 42;
        $('.chatroom_msg').css('height', heiht+'px');
        $('.header-app-btn,.right-arrow,.right,.left,.left_side_red_packet').click(function () {
            location.href = config.downloadUrl;
        })
    }

    function onChatroomConnect(chatroomInfo) {
        // console.log('进入聊天室', chatroomInfo);
        config.chatroomInfo = chatroomInfo;
    }
    function onChatroomWillReconnect(obj) {
        // console.log('即将重连', obj);
    }
    function onChatroomDisconnect(error) {
        // console.log('连接断开', error);
    }
    function onChatroomError(error, obj) {
        // console.log('发生错误', error, obj);
    }
    function onChatroomMsgs(msgs) {
        // console.log('收到聊天室消息', msgs);
        for(var i=0;i<msgs.length;i++){
            switch (msgs[i].type){
                case 'notification':
                    notification(msgs[i]);
                    break;
                case 'text':  //文本
                    msgText(msgs[i]);
                    break;
            }
        }
    }

    function msgText(msg) {//聊天室文本消息
        if(msg.custom){
            var custom = JSON.parse(msg.custom);
            var html = '';
            if(custom.look_num){ //观看人数刷新
                $('.live_title_riht').text(custom.look_num + ' 观看');
            }else if(custom.red_packet_id){ //红包
                console.log(custom);
                //左侧弹幕红包
                if($('.left_side_red_packet').length == 3) $('.left_side_red_packet').eq(0).remove();
                html = `<div class="left_side_red_packet">
                    <div class="left_side_front">
                         <img src="${custom.avatar}">
                    </div>
                    <div class="left_side_mid">
                        <span class="left_side_mid_name">${custom.nickname}</span>
                        <span class="left_side_mid_desc">${msg.text}</span>
                    </div>
                    <div class="left_side_behind"><img src="img/icon-red-packet.png"></div>
                </div>`;
                $('.red_container').append(html);
                $('.left_side_red_packet').unbind().click(function () {
                    location.href = config.downloadUrl;
                })
            }else if(custom.fromNick){//机器人消息fromNick
                html = `<p class="robot"><span class="robot_name">${custom.fromNick}: </span><span class="robot_text"> ${msg.text}</span></p>`;
                $('.chatroom_msg').append(html);
            }else if(custom.redId){
                //红包领取弹幕
                html = `<p class="red_packet"><span class="robot_name">${msg.fromNick}: </span><span class="red_packet_text"> ${msg.text}</span></p>`;
                $('.chatroom_msg').append(html);
            }else if(custom.live_status){
                //直播中断 0暂停 1直播中 2直播结束
                switch (custom.live_status) {
                    case '0':
                        $('.video-end').text('主播已中断画面,请耐心等候~').css('display','flex');
                        break ;
                    case '1':
                        location.reload();
                        break ;
                    case '2':
                        $('.video-end').text('直播已结束').css('display','flex');
                        break ;
                }

            }else{
                if(msg.fromNick) {//普通消息
                    html = `<p class="robot"><span class="robot_name">${msg.fromNick}: </span><span class="robot_text"> ${msg.text}</span></p>`;
                    $('.chatroom_msg').append(html);
                }
            }
        }else{
            if(msg.fromNick) {//普通消息
                html = `<p class="robot"><span class="robot_name">${msg.fromNick}: </span><span class="robot_text"> ${msg.text}</span></p>`;
                $('.chatroom_msg').append(html);
            }
        }
        goScrollTop();
    }

    function notification(msg) {//聊天室通知消息
        if(msg.attach.type == 'memberEnter'){
            var html = '';
            if(config.chatroomInfo.member.account === msg.attach.from){
                html = `<p class="notification"><span>欢迎你进入直播间</span></p>`;
            }else{
                html = `<p class="notification"><span>欢迎${msg.attach.toNick[0]}进入直播间</span></p>`;
            }
            $('.chatroom_msg').append(html);
        }
        goScrollTop();
    }

    function goScrollTop() {//定位到div底部
        var div = document.getElementById('chatroom_msg');
        div.scrollTop = div.scrollHeight;
    }
</script>

</body>
</html>