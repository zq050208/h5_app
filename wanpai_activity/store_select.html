<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1">
    <!-- <meta http-equiv="X-UA-Compatible" content="ie=edge"> -->
    <title>门面选拔</title>
    <link rel="stylesheet" href="https://unpkg.com/swiper/css/swiper.min.css">
    <style>
        * {
            padding: 0;
            margin: 0
        }

        html,
        body {
            width: 100%;
            height: auto;
            font-size: 14px;
            position: relative;
        }

        .header {
            width: 100%;
            height: 108.5vw;
            background: url("image/icon-store_bg.png") no-repeat;
            background-color: rgba(215, 0, 0, 1);
            background-size: cover;
            position: relative;
        }

        .header-img {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            position: absolute;
            bottom: 20px;
        }

        .middle {
            width: 100%;
            height: 100%;
            background: url("image/icon-bg.png") no-repeat;
            background-size: cover;
        }

        .center-img {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .storeTip {
            width: 87.2vw;
            height: 40px;
        }

        .xuanba_desc {
            width: 100%;
            height: 89.6vw;
        }

        .middle-content {
            width: 100%;
            height: 137.3vw;
            background: url("image/icon-store_nostart.png") no-repeat 100%/100%;
            padding: 10px 0 0px 0;
            position: relative;
        }

        /* 活动内容 */
        .list-content {
            width: 80%;
            height: 92vw;
            position: absolute;
            top: 12%;
            left: 10%;
            overflow-y: auto;
            z-index: 999;
        }

        /* 未开始 */
        .nocontent {
            width: 100%;
            height: 100%;
            font-size: 20px;
            font-family: PangMenZhengDao;
            color: rgba(185, 46, 2, 1);
            /* display: none; */
        }

        /* 已开始 */
        .startContent,
        .nolength {
            padding: 0 10px;
            min-height: 70vw;
        }

        .nolength {
            width: 100%;
            text-align: center;
            line-height: 70vw;
        }

        .startItem {
            display: flex;
            margin-bottom: 6px;
            color: rgba(185, 46, 2, 1);
        }

        .item_ranking {
            width: 35px;
            height: 37px;
            background: url("image/icon-ranking.png") no-repeat 100%/100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 7px;
            flex-shrink: 0;
        }

        .ranking {
            margin-left: 5px;
            font-size: 14px;
            font-family: PingFang-SC-Bold, PingFang-SC;
            font-weight: bold;
            color: rgba(255, 219, 0, 1);
        }

        .itemLeft {
            flex: 5;
            display: flex;
            align-items: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .item_name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .itemRight {
            flex: 5;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .searchCotent {
            padding: 10px
        }

        .search {
            width: 100%;
            height: 28px;
            border-radius: 8px;
            border: 1px solid rgba(246, 189, 96, 1);
            display: flex;
            /* justify-content: center; */
            align-items: center;
        }

        .search input {
            width: 85%;
            height: 28px;
            background: none;
            outline: none;
            border: 0;
            color: rgba(185, 46, 2, 1);
        }

        .vote {
            padding: 2px 14px;
            background: rgba(255, 219, 0, 1);
            border-radius: 4px;
            font-size: 12px;
            font-family: PingFang-SC-Bold, PingFang-SC;
            font-weight: bold;
            color: rgba(77, 77, 77, 1);
            margin-left: 10px;
        }

        .searchButton {
            width: 14px;
            height: 14px;
            vertical-align: middle;
            margin-left: 10px;
            margin-right: 6px;
        }

        /* 余票 */
        .residueTicket {
            position: absolute;
            bottom: 40px;
            right: 27px;
            width: 78px;
            height: 99px;
            background: url("image/icon-residueTicket.png") no-repeat 100%/100%;

        }

        .residueText {
            position: absolute;
            font-size: 12px;
            font-family: PingFang-SC-Bold, PingFang-SC;
            font-weight: bold;
            color: rgba(255, 255, 255, 1);
            bottom: 23px;
            left: 6px
        }

        /* 无票 */
        .noTicket,
        .vote-ticketContent {
            display: none;
        }

        /* 圆点 */
        .swiper-pagination {
            bottom: 18%;
            left: 25%;
        }

        .swiper-pagination-bullet {
            width: 12px !important;
            height: 12px !important;
            margin-right: 12px;
        }

        .swiper-pagination-bullet-active {
            background: rgba(255, 219, 0, 1) !important;
        }

        /* 弹框 */
        .vote-modal {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            z-index: 999;
            display: none;
        }

        .vote-mask {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: rgba(0, 0, 0, .1);
        }

        .vote-modal-content {
            width: 69.3vw;
            background: rgba(0, 0, 0, .7);
            z-index: 9999;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 8px;

        }

        .vote-modal-close {
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .close {
            width: 22px;
            height: 22px;
        }

        .column {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            font-family: PingFang-SC-Bold, PingFang-SC;
            font-weight: bold;
        }

        .voteName {
            font-size: 20px;
            color: rgba(255, 218, 0, 1);
            padding-bottom: 5px;
        }

        .ticketNum {
            font-size: 16px;
            color: rgba(255, 255, 255, 1);
        }

        .voteButton {
            width: 119px;
            height: 38px;
            background: rgba(255, 218, 0, 1);
            border-radius: 8px;
            text-align: center;
            line-height: 38px;
            font-size: 16px;
            font-family: PingFang-SC-Bold, PingFang-SC;
            font-weight: bold;
            color: rgba(0, 0, 0, 1);
            margin-bottom: 15px;
        }

        input {
            border: 1px solid rgba(255, 255, 255, 1);
            outline: none;
            background: none;
            padding: 8px;
            width: 47.5vw;
            color: rgba(255, 255, 255, 1);
            margin: 25px 0;
        }

        .vote-about {
            position: relative;
            padding: 7px;

        }

        .noEnough {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 50%;
            left: 50%;
            background: rgba(0, 0, 0, .7);
            border-radius: 8px;
            transform: translate(-50%, -50%);
            display: none;
        }

        .ticketText {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-family: PingFang-SC-Bold, PingFang-SC;
            font-weight: bold;
            color: rgba(255, 218, 0, 1);
        }

        #modal-bg {
            z-index: 999;
            position: fixed;
            right: 0;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 1);
            opacity: 0.6;
            display: none;
        }

        #modal {
            z-index: 999;
            position: fixed;
            top: 23.54%;
            width: 74.13%;
            left: 50%;
            transform: translateX(-50%);
            display: none;
        }

        .modal-top {
            z-index: 999;
            position: fixed;
            top: 0;
            left: 0;
            display: none;
        }

        .modal-top img {
            width: 100%;
            height: 137px;
        }

        .modal-desc {
            z-index: 999;
            position: fixed;
            width: 100%;
            top: 8.1%;
            text-align: center;
            display: none;
        }

        .modal-tip {
            margin-top: 16px;
            height: 39px;
            font-size: 13px;
            font-family: PingFang-SC-Bold, PingFang-SC;
            font-weight: bold;
            color: rgba(255, 255, 255, 1);
            line-height: 13px;
        }

        .my-card {
            height: 20px;
            font-size: 20px;
            font-family: PangMenZhengDao;
            color: rgba(255, 220, 134, 1);
            line-height: 23px;
        }

        .my-card-bot {
            width: 27px;
            height: 3px;
            background: rgba(255, 220, 134, 1);
            margin: 2px auto 0;
        }

        .modal-content {
            position: relative;
            width: 74.13vw;
            height: 107.73vw;
            border: 1px solid transparent;
            margin: 0 auto;
        }

        .copyImage{
            width: 74.13vw;
            height: 107.73vw;
            position: absolute;
            top:0;
            left:0;
            z-index: 10002;
            opacity:0;
        }

        .modal-content-bg {
            position: absolute;
            height: 100%;
            width: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }

        .modal-content-bg img {
            width: 100%;
            height: 100%;
        }

        .ticket_no {
            font-size: 10px;
            margin-bottom: 3px;
        }

        .modal-text {
            text-align: center;
            margin-top: 21vw;
            font-family: HYXiaoBoZheZhiTiJ;
            color: rgba(89, 89, 89, 1);
        }

        @media screen and (min-width: 414px) {
            .modal-text {
                margin-top: 25vw;
            }
        }

        .modal-image-content {
            position: relative;
        }

        .modal-image {
            width: 187px;
            height: 130px;
            margin: 6px 0 0 25px;
        }

        .modal-tips {
            background: rgba(0, 0, 0, .5);
            border-radius: 2px;
            width: 58.2vw;
            margin: 0 auto;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        .modal-tips .tips {
            font-size: 14px;
            font-family: HYXiaoBoZheZhiTiJ;
            color: rgba(255, 220, 134, 1);
            padding: 4px 10px;
        }

        .modal-time {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            font-family: HYXiaoBoZheZhiTiJ;
            color: rgba(75, 75, 75, 1);
            padding: 0 30px;
            margin-top: 6px;
        }

        .modal-content-bot {
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
            align-items: center;
            margin-top: 20px;
        }

        .descript {
            width: 142px;
            word-wrap: break-word;
            word-break: break-all;
            font-size: 12px;
            font-family: HYXiaoBoZheZhiTiJ;
            color: rgba(77, 77, 77, 1);
            text-align: left;
            margin-top: 5px;
        }

        .red {
            color: #DA0000
        }
        .modal-bottom{
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family:PingFang-SC-Medium,PingFang-SC;
            font-weight:500;
            color:rgba(255,255,255,1);
            margin-top: 16px;
        }
        .modal-bottom img {
            width: 210px;
            height: 64px;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-img">
            <img src="image/icon-year0.png" style="width: 234px; height: 63px;" class="yearImage">
        </div>
    </div>

    <div class="middle">
        <div class="center-img"><img src="image/icon-select_rule.png" style="width: 327px; height: 39px;"></div>
        <img src="image/icon-selectDesc.png" class="xuanba_desc">
        <div class="center-img"><img class="xuanbaImage" src="image/icon-xuanba-year0.png" style="width: 327px; height: 39px;"></div>
        <div class="middle-content">
            <div class="list-content">
                <!-- 搜索 -->
                <div class="searchCotent">
                    <div class="search">
                        <img src="image/icon-searchButton.png" class="searchButton">
                        <input type="text" placeholder="搜索" class="searchInput">
                    </div>
                </div>
                <!-- 已开始 -->
                <div class="swiper-container">
                    <div class="swiper-wrapper">

                    </div>
                </div>
            </div>
            <!-- 余票 -->
            <div class="residueTicket">
                <div class="residueText">余票：<span>0</span></div>
            </div>

            <!-- 如果需要分页器 -->
            <div class="swiper-pagination"></div>
        </div>
    </div>
    <!-- 弹框 -->
    <div class="vote-modal">
        <div class="vote-mask"></div>
        <div class="vote-modal-content">
            <div class="vote-about">
                <div class="vote-modal-close"><img src="image/icon-close.png" class="close"></div>
                <!-- 票 -->
                <div class="vote-ticketContent">
                    <div class="vote-column">
                        <span class="voteName">投票给肖战</span>
                        <span class="ticketNum residueNum">剩余3000票</span>
                        <input type="number" placeholder="请输入票数" class="voteTicket">
                        <div class="voteButton" onclick="handleVote()">投票</div>
                    </div>
                </div>
                <!-- 无票 -->
                <div class="noTicket">
                    <div class="vote-column">
                        <span class="ticketNum" style="padding-bottom: 18px">没有票了！</span>
                        <div class="voteButton" onclick="handleEarn()">去赚票</div>
                    </div>
                </div>
                <div class="noEnough">
                    <div class="ticketText"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-bg"></div>
    <div class="modal-top">
        <img src="image/icon-modal-top.png">
    </div>
    <div class="modal-desc">
        <div class="my-card">我的票卡</div>
        <div class="my-card-bot"></div>
        <div class="modal-tip">
            “将票卡分享至外部平台，每日票卡支持100人微信扫描” <br />
            扫描登录后，双方均可获得2票
        </div>
    </div>

    <div id="modal">
        <div>
            <div class="modal-content" id="modal-content">
                <img src="" class="copyImage" crossOrigin="anonymous">
                <div class="modal-content-bg">
                    <img src="https://cdn.tinytiger.cn/FvV7_uYUnx5T1_RoL9OcDYwEHcyV" crossOrigin="anonymous">
                </div>
                <div class="modal-text">
                    <div class="ticket_no">NO.<span id="ticket_no"></span></div>
                    <img src="https://cdn.tinytiger.cn/FrH8Ub6mT2hjgm5Edd2B-cZOkV4g" style="width: 145px;height: 16px;">
                    <div class="modal-image-content">
                        <img src="https://cdn.tinytiger.cn/FuZ0oNORLVTqurrKjK3WijPUbS3i" alt="" class="modal-image"
                            crossOrigin="anonymous">
                        <div class="modal-tips">
                            <div class="tips">除夕至初七门面资源位由你决定</div>
                        </div>
                    </div>
                    <div class="modal-time">
                        <div>DATE: <span class="red" id="card-date">2020/01/23</span></div>
                        <div>票卡次数: <span class="red">100</span></div>
                    </div>
                    <div class="modal-content-bot">
                        <div class="flexLeft">
                            <img src="https://cdn.tinytiger.cn/Fp1cV2uwbC35FhDAsPtTnDMC6aLY" style="width: 155px; height: 16px" crossOrigin="anonymous">
                            <!-- <div class="red" style="font-size: 10px; font-family: HYXiaoBoZheZhiTiJ;">分子派对活动票卡<span style="font-size: 8px;">（微信扫码）</span></div> -->
                            <div class="descript">扫描登录后,双方均可获得2票,送喜欢的人登新年门面资源位</div>
                        </div>
                        <div class="flexRight">
                            <img src="" crossOrigin="anonymous"
                                style="width: 63px; height: 64px;" id="qrcode">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-bottom">
                <!-- <img src="image/icon-saveButton.png" alt="" id="save-local">
                <div>— 本月票卡已被扫描 <span id="scan-times">55</span> 次 —</div> -->
                <div>（长按图片可保存、分享）</div>
            </div>
        </div>
    </div>
</body>

</html>
<script src="../public/jquery.min.js"></script>
<script src="../public/config.js"></script>
<script src="../public/service.js"></script>
<script src="../public/template-web.js"></script>
<script src="https://unpkg.com/swiper/js/swiper.min.js"> </script>
<script src="../public/html2canvas.min.js"></script>

<script type="text/html" id="voteList">
    <% for(var i=0;i< 8;i++){ %>
    <div class="swiper-slide">
        <div class="startContent">
            {{if item.length > 0}}
                {{each item v i}}
                <div class="startItem">
                    <div class="itemLeft">
                        <div class="item_ranking"><span class="ranking">{{i+1}}</span></div>
                        <div class="item_name">{{v.name}}</div>
                    </div>
                    <div class="itemRight">
                        <span>{{v.vote_num || 0}}票</span>
                        <span class="vote" onclick="voteClick({{v}})">投票</span>
                    </div>
                </div>
                {{/each}}
            {{else}}
                <div class="nocontent">
                    <div style="display: flex;flex-direction: column;justify-content: center; align-items: center;padding-top: 100px;">
                        <span>活动还未开始哦~ </span> <span>1月17日 18:00 敬请期待！</span>
                    </div>
                </div>
            {{/if}}
        </div>
    </div>
    <% } %>
</script>
<script>
    // baseUrl = 'http://192.168.1.241/wanpai_api/public/index.php/'   // 测试
    baseUrl = 'https://wanpai.titipa.cn/xhdj/wanpai_api/public/index.php/'   // 预发
    var config = {
        token: Request('token') || 'b0134788824b79f6ba96bea2472aae3e',
        rankUrl: 'PartyNewyearFacadeMember/getSelectedRankList',
        ticketUrl: 'PartyNewyearFacadeMember/getOtherTicket',
        userVoteUrl: 'PartyNewyearFacadeMember/userVote',
        getFacadeTicket: 'NewyearFacadeTicket/getFacadeTicket',
        getDefaultViewId: 'PartyNewyearFacadeMember/getView',
        rankData: {
            view_id: 1,
            name: ''
        },
        ticketData: {
            view_id: 1
        },
        userVoteData: {
            view_id: 1,
            member_id: null,
            num: null
        },
        type: 'get',
        ticketNum: 0
    }
    getTicket()
    // getFacadeTicket()
    getDefaultViewId().then(res => {
        getSelectedRankList(res.data.id - 1, true)
    })
    function setYearImage(viewID) {
        if(viewID === 0) {
            $(".xuanbaImage").attr('src', 'image/icon-xuanba-year0.png')
        } else if(viewID === 1) {
            $(".xuanbaImage").attr('src', 'image/icon-xuanba-year1.png')
        } else if(viewID === 2) {
            $(".xuanbaImage").attr('src', 'image/icon-xuanba-year2.png')
        } else if(viewID === 3) {
            $(".xuanbaImage").attr('src', 'image/icon-xuanba-year3.png')
        } else if(viewID === 4) {
            $(".xuanbaImage").attr('src', 'image/icon-xuanba-year4.png')
        } else if(viewID === 5) {
            $(".xuanbaImage").attr('src', 'image/icon-xuanba-year5.png')
        } else if(viewID === 6) {
            $(".xuanbaImage").attr('src', 'image/icon-xuanba-year6.png')
        } else if(viewID === 7) {
            $(".xuanbaImage").attr('src', 'image/icon-xuanba-year7.png')
        }
    }
    // swiper方法封装
    var mySwiper
    function swiper(initialSlide) {
        setYearImage(initialSlide)
        mySwiper = new Swiper('.swiper-container', {
            // direction: 'vertical', // 垂直切换选项
            loop: false, // 循环模式选项
            initialSlide: initialSlide || 0,
            // 如果需要分页器
            pagination: {
                el: '.swiper-pagination',
            },
            on: {
                slideChange: function () {
                    config.rankData.view_id = this.activeIndex + 1
                    config.userVoteData.view_id = this.activeIndex + 1
                    config.ticketData.view_id = this.activeIndex + 1
                    config.rankData.name = ''
                    $(".searchInput").val(null)
                    getSelectedRankList(config.rankData.view_id)
                    getTicket(config.ticketData.view_id)
                    if (config.rankData.view_id == 1) {
                        $(".yearImage").attr('src', 'image/icon-store_title.png')
                        $(".xuanbaImage").attr('src', 'image/icon-xuanba-year0.png')
                    } else if (config.rankData.view_id == 2) {
                        $(".yearImage").attr('src', 'image/icon-year1.png')
                        $(".xuanbaImage").attr('src', 'image/icon-xuanba-year1.png')
                    } else if (config.rankData.view_id == 3) {
                        $(".yearImage").attr('src', 'image/icon-year2.png')
                        $(".xuanbaImage").attr('src', 'image/icon-xuanba-year2.png')
                    } else if (config.rankData.view_id == 4) {
                        $(".yearImage").attr('src', 'image/icon-year3.png')
                        $(".xuanbaImage").attr('src', 'image/icon-xuanba-year3.png')
                    } else if (config.rankData.view_id == 5) {
                        $(".yearImage").attr('src', 'image/icon-year4.png')
                        $(".xuanbaImage").attr('src', 'image/icon-xuanba-year4.png')
                    } else if (config.rankData.view_id == 6) {
                        $(".yearImage").attr('src', 'image/icon-year5.png')
                        $(".xuanbaImage").attr('src', 'image/icon-xuanba-year5.png')
                    } else if (config.rankData.view_id == 7) {
                        $(".yearImage").attr('src', 'image/icon-year6.png')
                        $(".xuanbaImage").attr('src', 'image/icon-xuanba-year6.png')
                    } else if (config.rankData.view_id == 8) {
                        $(".yearImage").attr('src', 'image/icon-year7.png')
                        $(".xuanbaImage").attr('src', 'image/icon-xuanba-year7.png')
                    }
                }
            }
        })
    }
    //获取用户票卡
    function getFacadeTicket(index) {
        requsetHttp(config.getFacadeTicket, config.type, {}, config.token, (res) => {
            if (res.code == 200) {
                if (res.data) {
                    $('#qrcode').attr('src', res.data.card_qrcode_url)
                    $('#scan-times').html(res.data.scan_num)
                    $('#card-date').html(res.data.ticket_date)
                    $('#ticket_no').html(res.data.ticket_no)
                }
            }
        })
    }
    // 获取列表数据
    function getSelectedRankList(index, IfRender) {
        requsetHttp(config.rankUrl, config.type, config.rankData, config.token, (res) => {
            if (res.code == 200) {
                if (res.data == null) {
                    var tipString = config.rankData.name.length > 0 ? `<div class="nolength">暂无搜索数据</div>` : `<div class="nolength">暂无数据</div>`;
                    $($(".startContent")[index - 1]).html(tipString)
                } else if(res.data) {
                    var list = template('voteList', { item: res.data })
                    $(".swiper-wrapper").html(list)
                }
                if(IfRender) {
                    swiper(index)
                }
                // $(".nocontent").hide()
            } else {
                // $(".nocontent").show()
                var list = template('voteList', { item: [] })
                $(".swiper-wrapper").html(list)
                if(IfRender)
                swiper(index)
            }
        })
    }
    // 获取余票
    function getTicket() {
        requsetHttp(config.ticketUrl, config.type, config.ticketData, config.token, (res) => {
            if (res.code == 200) {
                config.ticketNum = res.data.num
                $(".residueText span").text(config.ticketNum)
            }
        })
    }
    // 获取默认页面
    function getDefaultViewId() {
        return new Promise((resolve, reject) => {
            requsetHttp(config.getDefaultViewId, config.type, {}, config.token, (res) => {
                if(res.code === 200) {
                    resolve(res)
                }
            })
        })
    }
    // 投票点击事件
    function voteClick(value) {
        $(".vote-modal").show()
        if (Number(config.ticketNum) <= 0) {
            $(".noTicket").show()
            return
        } else {
            $(".vote-ticketContent").show()
        }
        $(".voteName").text('投票给' + value.name)
        $(".residueNum").text('剩余 ' + config.ticketNum + ' 票')
        config.userVoteData.member_id = value.id
    }
    $(".searchInput").keyup(function () {
        console.log($(this).val())
        var search = $(this).val().trim()
        if (search.length > 0) {
            $(".startContent").html('')
        } else {
            getSelectedRankList(config.rankData.view_id)
        }
    })
    $(".searchInput").blur(function () {
        config.rankData.name = $(this).val()
        getSelectedRankList(config.rankData.view_id)

    })
    // 投票输入框
    $(".voteTicket").keyup(function () {
        config.userVoteData.num = Number($(this).val())
    })
    // 投票请求事件
    function handleVote() {
        requsetHttp(config.userVoteUrl, config.type, config.userVoteData, config.token, (res) => {
            if (res.code == 200) {
                $(".noEnough").show()
                setTimeout(() => {
                    $(".noEnough").hide()
                }, 1500)
                $(".ticketText").text('投票成功')
                $(".voteTicket").val('')
                getSelectedRankList(config.rankData.view_id)
                config.userVoteData.num = null
                getTicket()
            } else {
                $(".noEnough").show()
                setTimeout(() => {
                    $(".noEnough").hide()
                }, 1500)
                $(".ticketText").text(res.msg)
            }
        })
    }
    // 去赚票
    function handleEarn() {
        $(".vote-modal").hide()

        $("#modal").show()
        $("#modal-bg").show()
        $(".modal-desc").show()
        $(".modal-top").show()
        takeScreenshot();
        document.documentElement.style.position = 'fixed';
        document.body.style.overflow = 'hidden'; //隐藏滚动条
    }

    $("input").on('blur', function () {
        setTimeout(function () {
            $(window).scrollTop(document.body.scrollTop);
        }, 100)
    })

    $(".vote-mask, .close").click(function () {
        $(".vote-modal").hide()
        $(".noEnough").hide()
        $(".ticketText").text('')
    })

    $(".residueTicket").click(function () {
        $("#modal").show()
        $("#modal-bg").show()
        $(".modal-desc").show()
        $(".modal-top").show()
        takeScreenshot();
        document.documentElement.style.position = 'fixed';
        document.body.style.overflow = 'hidden'; //隐藏滚动条
    })

    var IMAGE_URL;
    function takeScreenshot() {
        var shareContent = document.getElementById('modal-content');//需要截图的包裹的（原生的）DOM 对象
        var width = shareContent.offsetWidth; //获取dom 宽度
        var height = shareContent.offsetHeight; //获取dom 高度
        var canvas = document.createElement("canvas"); //创建一个canvas节点

        var scale = 2; //定义任意放大倍数 支持小数
        canvas.width = width * scale; //定义canvas 宽度 * 缩放
        canvas.height = height * scale; //定义canvas高度 *缩放
        canvas.getContext("2d").scale(scale, scale); //获取context,设置scale

        // var rect = shareContent.getBoundingClientRect();//获取元素相对于视察的偏移量
        // canvas.getContext("2d").translate(-rect.left,-rect.top);//设置context位置，值为相对于视窗的偏移量负值，让图片复位
        var opts = {
            scale: scale, // 添加的scale 参数
            canvas: canvas, //自定义 canvas
            logging: false, //日志开关
            width: width, //dom 原始宽度
            height: height, //dom 原始高度
            backgroundColor: 'transparent',
            useCORS: true
        };
        html2canvas(shareContent, opts).then(function (canvas) {
            IMAGE_URL = canvas.toDataURL("image/png");
            $('.copyImage').attr('src',IMAGE_URL);
        })
    }

    function dataURLtoBlob(dataurl) {
        var arr = dataurl.split(','),
            mime = arr[0].match(/:(.*?);/)[1],
            bstr = atob(arr[1]),
            n = bstr.length,
            u8arr = new Uint8Array(n)
        while (n--) {
            u8arr[n] = bstr.charCodeAt(n)
        }
        return new Blob([u8arr], { type: mime })
    }

    function downloadBase64(dataUrl, filename) {
        var imageFile, href
        const downloadLink = document.createElement('a')
        // var downloadLink = document.getElementById('dl-hidden')
        try {
            var blob = dataURLtoBlob(dataUrl)
            var href = window.URL.createObjectURL(blob)
            downloadLink.download = filename
            downloadLink.href = href
            downloadLink.click()
        } catch (err) {
        } finally {
            if (href) {
                window.URL.revokeObjectURL(href)
            }
            // downloadLink.remove()
        }
    }

    // takeScreenshot();
    $("#modal-bg").click(function (e) {
        $("#modal").hide()
        $("#modal-bg").hide()
        $(".modal-desc").hide()
        $(".modal-top").hide()
        document.documentElement.style.position = 'static';
        document.body.style.overflow = '';
    })

    $("#save-local").click(function (e) {
        downloadBase64(IMAGE_URL, '我的票卡.png')
        $("#modal").hide()
        $("#modal-bg").hide()
        document.documentElement.style.position = 'static';
        document.body.style.overflow = '';
    })
</script>